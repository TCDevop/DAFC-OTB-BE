// ============================================================================
// DAFC OTB Planning System - Database Schema (New Design - MSSQL)
// Tech: SQL Server (Azure) + Prisma ORM
// Updated: 2026-02-11
// ============================================================================
generator client {
  provider = "prisma-client-js"
  // output = "../src/generated/prisma" // Keep if needed
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================

model User {
  userId       String   @id @default(cuid()) @map("id")
  userEmail    String   @unique @map("email")
  userName     String   @map("name")
  passwordHash String   @map("password_hash")
  roleId       String   @map("role_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Authorization (Data Access)
  storeAccess String @default("[]") @map("store_access") @db.NVarChar(Max) // JSON: ["store_id_1", "store_id_2"]
  brandAccess String @default("[]") @map("brand_access") @db.NVarChar(Max) // JSON: ["brand_id_1", "brand_id_2"]

  // Relations
  role                      Role                    @relation(fields: [roleId], references: [roleId], onDelete: NoAction, onUpdate: NoAction)
  createdBudgets            Budget[]                @relation("CreatedBudgets")
  createdAllocateHeaders    AllocateHeader[]        @relation("CreatedAllocateHeaders")
  createdPlanningHeaders    PlanningHeader[]        @relation("CreatedPlanningHeaders")
  createdSkuProposalHeaders SKUProposalHeader[]     @relation("CreatedSKUProposalHeaders")
  createdTickets            Ticket[]                @relation("CreatedTickets")
  approvalWorkflowLevels    ApprovalWorkflowLevel[] @relation("ApproverUser")
  ticketApprovalLogs        TicketApprovalLog[]     @relation("ApproverLogs")

  @@map("users")
}

model Role {
  roleId      String  @id @default(cuid()) @map("id")
  roleName    String  @unique @map("name") // buyer, merchandiser, merch_manager, etc.
  description String?
  permissions String  @default("[]") @db.NVarChar(Max) // JSON: ["budget:read", "budget:write"]

  // Relations
  users User[]

  @@map("roles")
}

// ============================================
// BRAND HIERARCHY
// ============================================

model GroupBrand {
  groupBrandId   String   @id @default(cuid()) @map("id")
  groupBrandCode String   @unique @map("code")
  groupBrandName String   @map("name")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  brands            Brand[]            @relation("GroupBrandToBrand")
  approvalWorkflows ApprovalWorkflow[] @relation("GroupBrandToWorkflow")

  @@map("group_brands")
}

model Brand {
  brandId      String   @id @default(cuid()) @map("id")
  brandCode    String   @unique @map("code")
  brandName    String   @map("name")
  groupBrandId String   @map("group_brand_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  groupBrand GroupBrand @relation("GroupBrandToBrand", fields: [groupBrandId], references: [groupBrandId], onDelete: NoAction, onUpdate: NoAction)
  products   Product[]  @relation("BrandToProduct")
  budgets    Budget[]   @relation("BrandToBudget")

  @@map("brands")
}

// ============================================
// STORE & LOCATION
// ============================================

model Store {
  storeId   String   @id @default(cuid()) @map("id")
  storeCode String   @unique @map("code")
  storeName String   @map("name")
  region    String?
  location  String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  budgetAllocates     BudgetAllocate[]     @relation("StoreToBudgetAllocate")
  planningCollections PlanningCollection[] @relation("StoreToPlanningCollection")
  planningGenders     PlanningGender[]     @relation("StoreToPlanningGender")
  skuAllocates        SKUAllocate[]        @relation("StoreToSKUAllocate")

  @@map("stores")
}

// ============================================
// PRODUCT TAXONOMY & ATTRIBUTES
// ============================================

model Collection {
  collectionId   String  @id @default(cuid()) @map("id")
  collectionName String  @unique @map("name")
  isActive       Boolean @default(true) @map("is_active")

  // Relations
  planningCollections PlanningCollection[] @relation("CollectionToPlanningCollection")

  @@map("collections")
}

model SeasonGroup {
  seasonGroupId   String  @id @default(cuid()) @map("id")
  seasonGroupName String  @unique @map("name")
  isActive        Boolean @default(true) @map("is_active")

  // Relations
  seasons         Season[]         @relation("SeasonGroupToSeason")
  budgetAllocates BudgetAllocate[] @relation("SeasonGroupToBudgetAllocate")

  @@map("season_groups")
}

model Season {
  seasonId      String  @id @default(cuid()) @map("id")
  seasonName    String  @unique @map("name")
  seasonGroupId String  @map("season_group_id")
  isActive      Boolean @default(true) @map("is_active")

  // Relations
  seasonGroup     SeasonGroup      @relation("SeasonGroupToSeason", fields: [seasonGroupId], references: [seasonGroupId], onDelete: Cascade)
  budgetAllocates BudgetAllocate[] @relation("SeasonToBudgetAllocate")

  @@map("seasons")
}

model Gender {
  genderId   String  @id @default(cuid()) @map("id")
  genderName String  @unique @map("name")
  isActive   Boolean @default(true) @map("is_active")

  // Relations
  categories      Category[]       @relation("GenderToCategory")
  planningGenders PlanningGender[] @relation("GenderToPlanningGender")

  @@map("genders")
}

model Category {
  categoryId   String  @id @default(cuid()) @map("id")
  categoryName String  @map("name")
  genderId     String  @map("gender_id")
  isActive     Boolean @default(true) @map("is_active")

  // Relations
  gender        Gender        @relation("GenderToCategory", fields: [genderId], references: [genderId], onDelete: Cascade)
  subCategories SubCategory[] @relation("CategoryToSubCategory")

  @@map("categories")
}

model SubCategory {
  subCategoryId   String  @id @default(cuid()) @map("id")
  subCategoryName String  @map("name")
  categoryId      String  @map("category_id")
  isActive        Boolean @default(true) @map("is_active")

  // Relations
  category           Category           @relation("CategoryToSubCategory", fields: [categoryId], references: [categoryId], onDelete: Cascade)
  products           Product[]          @relation("SubCategoryToProduct")
  subcategorySizes   SubcategorySize[]  @relation("SubCategoryToSize")
  planningCategories PlanningCategory[] @relation("SubCategoryToPlanningCategory")

  @@map("sub_categories")
}

model SubcategorySize {
  subcategorySizeId String @id @default(cuid()) @map("id")
  sizeName          String @map("name")
  subCategoryId     String @map("sub_category_id")

  // Relations
  subCategory     SubCategory      @relation("SubCategoryToSize", fields: [subCategoryId], references: [subCategoryId], onDelete: Cascade)
  proposalSizings ProposalSizing[] @relation("SizeToProposalSizing")

  @@map("subcategory_sizes")
}

// ============================================
// PRODUCT CATALOG
// ============================================

model Product {
  productId     String   @id @default(cuid()) @map("id")
  skuCode       String   @unique @map("sku_code")
  productName   String   @map("product_name")
  subCategoryId String   @map("sub_category_id")
  theme         String?
  color         String?
  composition   String?
  srp           Decimal  @db.Decimal(18, 2)
  brandId       String?  @map("brand_id")
  imageUrl      String?  @map("image_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  brand        Brand?        @relation("BrandToProduct", fields: [brandId], references: [brandId], onDelete: SetNull)
  subCategory  SubCategory   @relation("SubCategoryToProduct", fields: [subCategoryId], references: [subCategoryId], onDelete: NoAction, onUpdate: NoAction)
  skuProposals SKUProposal[] @relation("ProductToSKUProposal")

  @@map("products")
}

// ============================================
// BUDGET MANAGEMENT
// ============================================

model Budget {
  budgetId     String   @id @default(uuid()) @map("id")
  budgetName   String   @map("name")
  brandId      String   @map("brand_id")
  budgetAmount Decimal  @map("amount") @db.Decimal(18, 2)
  description  String?
  budgetStatus String   @default("DRAFT") @map("status")
  fiscalYear   Int      @map("fiscal_year")
  createdBy    String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  brand           Brand            @relation("BrandToBudget", fields: [brandId], references: [brandId], onDelete: NoAction, onUpdate: NoAction)
  creator         User             @relation("CreatedBudgets", fields: [createdBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  allocateHeaders AllocateHeader[] @relation("BudgetToAllocateHeader")

  @@map("budgets")
}

model AllocateHeader {
  allocateHeaderId String   @id @default(cuid()) @map("id")
  budgetId         String   @map("budget_id")
  version          Int
  createdBy        String   @map("created_by")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  budget          Budget           @relation("BudgetToAllocateHeader", fields: [budgetId], references: [budgetId], onDelete: Cascade)
  creator         User             @relation("CreatedAllocateHeaders", fields: [createdBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  budgetAllocates BudgetAllocate[] @relation("AllocateHeaderToBudgetAllocate")

  @@map("allocate_headers")
}

model BudgetAllocate {
  budgetAllocateId String  @id @default(cuid()) @map("id")
  allocateHeaderId String  @map("allocate_header_id")
  storeId          String  @map("store_id")
  seasonGroupId    String  @map("season_group_id")
  seasonId         String  @map("season_id")
  budgetAmount     Decimal @default(0) @map("budget_amount") @db.Decimal(18, 2)

  // Relations
  allocateHeader AllocateHeader @relation("AllocateHeaderToBudgetAllocate", fields: [allocateHeaderId], references: [allocateHeaderId], onDelete: Cascade)
  store          Store          @relation("StoreToBudgetAllocate", fields: [storeId], references: [storeId], onDelete: NoAction, onUpdate: NoAction)
  seasonGroup    SeasonGroup    @relation("SeasonGroupToBudgetAllocate", fields: [seasonGroupId], references: [seasonGroupId], onDelete: NoAction, onUpdate: NoAction)
  season         Season         @relation("SeasonToBudgetAllocate", fields: [seasonId], references: [seasonId], onDelete: NoAction, onUpdate: NoAction)
  tickets        Ticket[]       @relation("BudgetAllocateToTicket")

  @@map("budget_allocates")
}

// ============================================
// PLANNING & FORECASTING
// ============================================

model PlanningHeader {
  planningHeaderId String   @id @default(cuid()) @map("id")
  version          Int
  planningStatus   String   @default("DRAFT") @map("status")
  createdBy        String   @map("created_by")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  creator             User                 @relation("CreatedPlanningHeaders", fields: [createdBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  planningCollections PlanningCollection[] @relation("PlanningHeaderToCollection")
  planningGenders     PlanningGender[]     @relation("PlanningHeaderToGender")
  planningCategories  PlanningCategory[]   @relation("PlanningHeaderToCategory")
  tickets             Ticket[]             @relation("PlanningHeaderToTicket")

  @@map("planning_headers")
}

model PlanningCollection {
  planningCollectionId String @id @default(cuid()) @map("id")
  collectionId         String @map("collection_id")
  storeId              String @map("store_id")
  planningHeaderId     String @map("planning_header_id")

  actualBuyPct      Decimal @default(0) @map("actual_buy_pct") @db.Decimal(18, 2)
  actualSalesPct    Decimal @default(0) @map("actual_sales_pct") @db.Decimal(18, 2)
  actualStPct       Decimal @default(0) @map("actual_st_pct") @db.Decimal(18, 2)
  actualMoc         Decimal @default(0) @map("actual_moc") @db.Decimal(18, 2)
  proposedBuyPct    Decimal @default(0) @map("proposed_buy_pct") @db.Decimal(18, 2)
  otbProposedAmount Decimal @default(0) @map("otb_proposed_amount") @db.Decimal(18, 2)
  pctVarVsLast      Decimal @default(0) @map("pct_var_vs_last") @db.Decimal(18, 2)

  // Relations
  collection     Collection     @relation("CollectionToPlanningCollection", fields: [collectionId], references: [collectionId], onDelete: NoAction, onUpdate: NoAction)
  store          Store          @relation("StoreToPlanningCollection", fields: [storeId], references: [storeId], onDelete: NoAction, onUpdate: NoAction)
  planningHeader PlanningHeader @relation("PlanningHeaderToCollection", fields: [planningHeaderId], references: [planningHeaderId], onDelete: Cascade)

  @@map("planning_collections")
}

model PlanningGender {
  planningGenderId String @id @default(cuid()) @map("id")
  genderId         String @map("gender_id")
  storeId          String @map("store_id")
  planningHeaderId String @map("planning_header_id")

  actualBuyPct      Decimal @default(0) @map("actual_buy_pct") @db.Decimal(18, 2)
  actualSalesPct    Decimal @default(0) @map("actual_sales_pct") @db.Decimal(18, 2)
  actualStPct       Decimal @default(0) @map("actual_st_pct") @db.Decimal(18, 2)
  proposedBuyPct    Decimal @default(0) @map("proposed_buy_pct") @db.Decimal(18, 2)
  otbProposedAmount Decimal @default(0) @map("otb_proposed_amount") @db.Decimal(18, 2)
  pctVarVsLast      Decimal @default(0) @map("pct_var_vs_last") @db.Decimal(18, 2)

  // Relations
  gender         Gender         @relation("GenderToPlanningGender", fields: [genderId], references: [genderId], onDelete: NoAction, onUpdate: NoAction)
  store          Store          @relation("StoreToPlanningGender", fields: [storeId], references: [storeId], onDelete: NoAction, onUpdate: NoAction)
  planningHeader PlanningHeader @relation("PlanningHeaderToGender", fields: [planningHeaderId], references: [planningHeaderId], onDelete: Cascade)

  @@map("planning_genders")
}

model PlanningCategory {
  planningCategoryId String @id @default(cuid()) @map("id")
  subCategoryId      String @map("subcategory_id")
  planningHeaderId   String @map("planning_header_id")

  actualBuyPct      Decimal @default(0) @map("actual_buy_pct") @db.Decimal(18, 2)
  actualSalesPct    Decimal @default(0) @map("actual_sales_pct") @db.Decimal(18, 2)
  actualStPct       Decimal @default(0) @map("actual_st_pct") @db.Decimal(18, 2)
  proposedBuyPct    Decimal @default(0) @map("proposed_buy_pct") @db.Decimal(18, 2)
  otbProposedAmount Decimal @default(0) @map("otb_proposed_amount") @db.Decimal(18, 2)
  varLastYearPct    Decimal @default(0) @map("var_lastyear_pct") @db.Decimal(18, 2)
  otbActualAmount   Decimal @default(0) @map("otb_actual_amount") @db.Decimal(18, 2)
  otbActualBuyPct   Decimal @default(0) @map("otb_actual_buy_pct") @db.Decimal(18, 2)

  // Relations
  subCategory    SubCategory    @relation("SubCategoryToPlanningCategory", fields: [subCategoryId], references: [subCategoryId], onDelete: NoAction, onUpdate: NoAction)
  planningHeader PlanningHeader @relation("PlanningHeaderToCategory", fields: [planningHeaderId], references: [planningHeaderId], onDelete: Cascade)

  @@map("planning_categories")
}

// ============================================
// SKU PROPOSAL & ALLOCATION
// ============================================

model SKUProposalHeader {
  skuProposalHeaderId String   @id @default(cuid()) @map("id")
  version             Int
  proposalStatus      String   @default("DRAFT") @map("status")
  createdBy           String   @map("created_by")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  creator      User          @relation("CreatedSKUProposalHeaders", fields: [createdBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  skuProposals SKUProposal[] @relation("SKUProposalHeaderToSKUProposal")
  tickets      Ticket[]      @relation("SKUProposalHeaderToTicket")

  @@map("sku_proposal_headers")
}

model SKUProposal {
  skuProposalId       String  @id @default(cuid()) @map("id")
  skuProposalHeaderId String  @map("sku_proposal_header_id")
  productId           String  @map("product_id")
  customerTarget      String  @map("customer_target")
  unitCost            Decimal @default(0) @map("unit_cost") @db.Decimal(18, 2)
  srp                 Decimal @default(0) @db.Decimal(18, 2)
  selectedSizingChoice Int     @default(1) @map("selected_sizing_choice")

  // Relations
  skuProposalHeader SKUProposalHeader @relation("SKUProposalHeaderToSKUProposal", fields: [skuProposalHeaderId], references: [skuProposalHeaderId], onDelete: Cascade)
  product           Product           @relation("ProductToSKUProposal", fields: [productId], references: [productId], onDelete: NoAction, onUpdate: NoAction)
  skuAllocates      SKUAllocate[]     @relation("SKUProposalToSKUAllocate")
  proposalSizings   ProposalSizing[]  @relation("SKUProposalToProposalSizing")

  @@map("sku_proposals")
}

model SKUAllocate {
  skuAllocateId String  @id @default(cuid()) @map("id")
  skuProposalId String  @map("sku_proposal_id")
  storeId       String  @map("store_id")
  quantity      Decimal @default(0) @db.Decimal(18, 2)

  // Relations
  skuProposal SKUProposal @relation("SKUProposalToSKUAllocate", fields: [skuProposalId], references: [skuProposalId], onDelete: Cascade)
  store       Store       @relation("StoreToSKUAllocate", fields: [storeId], references: [storeId], onDelete: NoAction, onUpdate: NoAction)

  @@map("sku_allocates")
}

model ProposalSizing {
  proposalSizingId  String  @id @default(cuid()) @map("id")
  skuProposalId     String  @map("sku_proposal_id")
  subcategorySizeId String  @map("subcategory_size_id")
  sizingChoice      Int     @default(1) @map("sizing_choice")
  actualSalesmixPct Decimal @default(0) @map("actual_salesmix_pct") @db.Decimal(18, 2)
  actualStPct       Decimal @default(0) @map("actual_st_pct") @db.Decimal(18, 2)
  proposalQuantity  Int     @map("proposal_quantity")

  // Relations
  skuProposal     SKUProposal     @relation("SKUProposalToProposalSizing", fields: [skuProposalId], references: [skuProposalId], onDelete: Cascade)
  subcategorySize SubcategorySize @relation("SizeToProposalSizing", fields: [subcategorySizeId], references: [subcategorySizeId], onDelete: NoAction, onUpdate: NoAction)

  @@unique([skuProposalId, subcategorySizeId, sizingChoice], name: "unique_sizing_choice")
  @@map("proposal_sizings")
}

// ============================================
// APPROVAL WORKFLOW & TICKETS
// ============================================



model Ticket {
  ticketId         String   @id @default(cuid()) @map("id")
  budgetAllocateId      String   @map("budget_allocate_id")
  planningHeaderId      String?  @map("planning_header_id")
  skuProposalHeaderId   String?  @map("sku_proposal_id")
  ticketStatus          String   @default("PENDING") @map("status")
  createdBy             String   @map("created_by")
  createdAt             DateTime @default(now()) @map("created_at")

  // Relations
  budgetAllocate      BudgetAllocate        @relation("BudgetAllocateToTicket", fields: [budgetAllocateId], references: [budgetAllocateId], onDelete: Cascade)
  planningHeader      PlanningHeader?       @relation("PlanningHeaderToTicket", fields: [planningHeaderId], references: [planningHeaderId], onDelete: NoAction, onUpdate: NoAction)
  skuProposalHeader   SKUProposalHeader?    @relation("SKUProposalHeaderToTicket", fields: [skuProposalHeaderId], references: [skuProposalHeaderId], onDelete: NoAction, onUpdate: NoAction)
  creator             User                  @relation("CreatedTickets", fields: [createdBy], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  ticketApprovalLogs  TicketApprovalLog[]   @relation("TicketToApprovalLog")

  @@map("tickets")
}

model ApprovalWorkflow {
  approvalWorkflowId String @id @default(cuid()) @map("id")
  groupBrandId       String @map("group_brand_id")
  workflowName       String @map("workflow_name")

  // Relations
  groupBrand             GroupBrand              @relation("GroupBrandToWorkflow", fields: [groupBrandId], references: [groupBrandId], onDelete: Cascade)
  approvalWorkflowLevels ApprovalWorkflowLevel[] @relation("WorkflowToLevel")

  @@map("approval_workflows")
}

model ApprovalWorkflowLevel {
  approvalWorkflowLevelId String  @id @default(cuid()) @map("id")
  approvalWorkflowId      String  @map("approval_workflow_id")
  levelOrder              Int     @map("level_order")
  levelName               String  @map("level_name")
  approverUserId          String  @map("approver_user_id")
  isRequired              Boolean @map("is_required")

  // Relations
  approvalWorkflow   ApprovalWorkflow    @relation("WorkflowToLevel", fields: [approvalWorkflowId], references: [approvalWorkflowId], onDelete: Cascade)
  approverUser       User                @relation("ApproverUser", fields: [approverUserId], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  ticketApprovalLogs TicketApprovalLog[] @relation("LevelToApprovalLog")

  @@map("approval_workflow_levels")
}

model TicketApprovalLog {
  ticketApprovalLogId     String    @id @default(cuid()) @map("id")
  ticketId                String    @map("ticket_id")
  approvalWorkflowLevelId String    @map("approval_workflow_level_id")
  approverUserId          String    @map("approver_user_id")
  isApproved              Boolean   @map("is_approved")
  comment                 String?
  approvedAt              DateTime? @map("approved_at")
  createdAt               DateTime  @default(now()) @map("created_at")

  // Relations
  ticket                Ticket                @relation("TicketToApprovalLog", fields: [ticketId], references: [ticketId], onDelete: Cascade)
  approvalWorkflowLevel ApprovalWorkflowLevel @relation("LevelToApprovalLog", fields: [approvalWorkflowLevelId], references: [approvalWorkflowLevelId], onDelete: NoAction, onUpdate: NoAction)
  approverUser          User                  @relation("ApproverLogs", fields: [approverUserId], references: [userId], onDelete: NoAction, onUpdate: NoAction)

  @@map("ticket_approval_logs")
}
